-- Auto Fishing Script - No Lag Optimized Version
-- Hotkey: J = Toggle GUI | K = Start/Stop

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Stats = game:GetService("Stats")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ===== WEBHOOK DISCORD ANDA =====
local WEBHOOK_URL = "https://discord.com/api/webhooks/1461393962618060957/JAb0w8aEoWOV77_RCjN0fDhGJU5cbic6ZJQqlPL2JMzMztSQfFckuanMbYMXLTGdnNBN"
-- ================================

-- Config
local config = {
    enabled = false,
    autoWinMode = false,
    antiAFK = true,
    castHoldTime = 0.7,
    updateInterval = 60,
    webhookEnabled = true
}

-- Status Variables
local isMinigameActive = false
local isCasting = false
local clickConnection = nil
local lastCastTime = 0
local fishCaught = 0
local wasMinigameActive = false
local startTime = 0
local stoppedTime = 0
local afkRemote = nil
local lastWebhookUpdate = 0
local sessionStart = os.date("%Y-%m-%d %H:%M:%S")

-- Anti-AFK Loops
local afkSpamLoop = nil
local afkMouseLoop = nil

-- GUI Reference
local toggleBtn = nil
local statsLabel = nil

-- Cache untuk UI elements (mengurangi FindFirstChild berulang)
local fishingRodGUI = nil
local miniGameGUI = nil
local imageLabel = nil
local lastUICheck = 0
local uiCheckInterval = 0.5

-- ===== DISCORD WEBHOOK FUNCTIONS =====
local function sendWebhookRequest(data)
    task.spawn(function() -- Async untuk tidak block main thread
        local success = false
        
        pcall(function()
            if http_request then
                http_request({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = data
                })
                success = true
            end
        end)
        
        if success then return end
        
        pcall(function()
            if request then
                request({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = data
                })
                success = true
            end
        end)
        
        if success then return end
        
        pcall(function()
            if syn and syn.request then
                syn.request({
                    Url = WEBHOOK_URL,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = data
                })
            end
        end)
    end)
end

local function sendWebhook(title, description, color, fields)
    if not config.webhookEnabled then return end
    
    task.spawn(function() -- Async webhook
        local embed = {
            ["title"] = title,
            ["description"] = description,
            ["color"] = color or 3447003,
            ["fields"] = fields or {},
            ["footer"] = {
                ["text"] = "Auto Fish Bot ‚Ä¢ " .. player.Name
            },
            ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }
        
        local data = {
            ["embeds"] = {embed}
        }
        
        local jsonData = HttpService:JSONEncode(data)
        sendWebhookRequest(jsonData)
    end)
end

local function sendStatusUpdate()
    if not config.enabled then return end
    
    local runtime = math.floor(tick() - startTime)
    local hours = math.floor(runtime / 3600)
    local minutes = math.floor((runtime % 3600) / 60)
    local secs = runtime % 60
    local timeStr = string.format("%02dh %02dm %02ds", hours, minutes, secs)
    
    local fps = 60 -- Default value untuk menghindari lag dari calculation
    local ping = 0
    
    pcall(function()
        ping = math.floor(Stats.Network.ServerStatsItem["Data Ping"]:GetValue())
    end)
    
    local fishPerHour = runtime > 0 and math.floor(fishCaught / (runtime / 3600)) or 0
    
    local fields = {
        {name = "üìä Status", value = "```yaml\n‚úÖ AKTIF BERJALAN```", inline = false},
        {name = "‚öôÔ∏è Mode", value = "```" .. (config.autoWinMode and "Auto Win" or "Tap-Tap") .. "```", inline = true},
        {name = "üé£ Ikan", value = "```" .. tostring(fishCaught) .. "```", inline = true},
        {name = "‚è±Ô∏è Runtime", value = "```" .. timeStr .. "```", inline = true},
        {name = "üìà Ikan/Jam", value = "```" .. tostring(fishPerHour) .. "```", inline = true},
        {name = "üì° Ping", value = "```" .. tostring(ping) .. "ms```", inline = true},
        {name = "üïê Mulai", value = "```" .. sessionStart .. "```", inline = false}
    }
    
    sendWebhook(
        "üé£ Auto Fishing - Status Update",
        "*Live monitoring - Update setiap " .. config.updateInterval .. " detik*",
        16776960,
        fields
    )
end

local function sendStartMessage()
    local fields = {
        {name = "üë§ Player", value = "```" .. player.Name .. "```", inline = true},
        {name = "‚öôÔ∏è Mode", value = "```" .. (config.autoWinMode and "Auto Win" or "Tap-Tap") .. "```", inline = true},
        {name = "üïê Session Start", value = "```" .. sessionStart .. "```", inline = false},
        {name = "‚ö° Kontrol", value = "```J = Toggle GUI\nK = Start/Stop```", inline = false}
    }
    
    sendWebhook(
        "üé£ Auto Fishing Started",
        "**Bot telah diaktifkan!**\nStatus akan di-update secara berkala.",
        3066993,
        fields
    )
end

local function sendStopMessage()
    local runtime = math.floor(tick() - startTime)
    local hours = math.floor(runtime / 3600)
    local minutes = math.floor((runtime % 3600) / 60)
    local secs = runtime % 60
    local timeStr = string.format("%02dh %02dm %02ds", hours, minutes, secs)
    
    local fishPerHour = runtime > 0 and math.floor(fishCaught / (runtime / 3600)) or 0
    
    local fields = {
        {name = "üé£ Total Ikan", value = "```" .. tostring(fishCaught) .. "```", inline = true},
        {name = "‚è±Ô∏è Runtime", value = "```" .. timeStr .. "```", inline = true},
        {name = "üìà Ikan/Jam", value = "```" .. tostring(fishPerHour) .. "```", inline = true},
        {name = "üìä Summary", value = "```yaml\nBot telah dihentikan\nSesi selesai```", inline = false}
    }
    
    sendWebhook(
        "üõë Auto Fishing Stopped",
        "**Bot telah dinonaktifkan**",
        15158332,
        fields
    )
end

local function sendModeChange()
    if not config.enabled then return end
    
    local runtime = math.floor(tick() - startTime)
    local hours = math.floor(runtime / 3600)
    local minutes = math.floor((runtime % 3600) / 60)
    local secs = runtime % 60
    local timeStr = string.format("%02dh %02dm %02ds", hours, minutes, secs)
    
    local fields = {
        {name = "‚öôÔ∏è Mode Baru", value = "```" .. (config.autoWinMode and "Auto Win" or "Tap-Tap") .. "```", inline = true},
        {name = "üé£ Ikan", value = "```" .. tostring(fishCaught) .. "```", inline = true},
        {name = "‚è±Ô∏è Runtime", value = "```" .. timeStr .. "```", inline = true}
    }
    
    sendWebhook(
        "‚öôÔ∏è Mode Changed",
        "**Mode fishing telah diubah**",
        10181046,
        fields
    )
end

-- ===== ANTI-AFK SYSTEM =====
local function findAFKRemote()
    afkRemote = ReplicatedStorage:FindFirstChild("AFK")
    if not afkRemote then
        task.wait(2)
        afkRemote = ReplicatedStorage:FindFirstChild("AFK")
    end
    return afkRemote
end

local function startAntiAFK()
    if not afkRemote then
        findAFKRemote()
    end
    
    if not afkRemote then
        return
    end
    
    UserInputService.WindowFocusReleased:Connect(function()
        if config.enabled then
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    UserInputService.WindowFocused:Connect(function()
        if config.enabled then
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    if afkSpamLoop then
        task.cancel(afkSpamLoop)
    end
    
    afkSpamLoop = task.spawn(function()
        while config.enabled do
            task.wait(2) -- Kurangi frequency untuk mengurangi lag
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    if afkMouseLoop then
        task.cancel(afkMouseLoop)
    end
    
    afkMouseLoop = task.spawn(function()
        while config.enabled do
            task.wait(5) -- Kurangi frequency
            local vp = workspace.CurrentCamera.ViewportSize
            pcall(function()
                VirtualInputManager:SendMouseMoveEvent(
                    vp.X/2 + math.random(-2, 2),
                    vp.Y/2 + math.random(-2, 2),
                    game
                )
            end)
        end
    end)
end

local function stopAntiAFK()
    if afkSpamLoop then
        task.cancel(afkSpamLoop)
        afkSpamLoop = nil
    end
    if afkMouseLoop then
        task.cancel(afkMouseLoop)
        afkMouseLoop = nil
    end
end

-- ===== CACHED UI FUNCTIONS (NO LAG) =====
local function updateUICache()
    local currentTime = tick()
    if currentTime - lastUICheck < uiCheckInterval then
        return
    end
    
    lastUICheck = currentTime
    
    -- Cache FishingRodGUI
    if not fishingRodGUI or not fishingRodGUI.Parent then
        fishingRodGUI = playerGui:FindFirstChild("FishingRodGUI")
        if fishingRodGUI then
            local background = fishingRodGUI:FindFirstChild("Background")
            if background then
                imageLabel = background:FindFirstChild("ImageLabel")
            end
        end
    end
    
    -- Cache MiniGameGUI
    if not miniGameGUI or not miniGameGUI.Parent then
        miniGameGUI = playerGui:FindFirstChild("MiniGameGUI")
    end
end

local function getClickPosition()
    if imageLabel and imageLabel.Parent and imageLabel.Visible then
        local absolutePos = imageLabel.AbsolutePosition
        local absoluteSize = imageLabel.AbsoluteSize
        
        local clickX = absolutePos.X + (absoluteSize.X / 2)
        local clickY = absolutePos.Y + absoluteSize.Y + 30
        
        return clickX, clickY
    end
    
    -- Fallback
    local center = workspace.CurrentCamera.ViewportSize / 2
    return center.X, center.Y
end

-- ===== FISHING FUNCTIONS (NO LAG) =====
local function holdClick(duration)
    local clickX, clickY = getClickPosition()
    
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, true, game, 0)
    task.wait(duration)
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, false, game, 0)
end

local function castFishingRod()
    if isCasting then return end
    
    task.spawn(function() -- Async cast untuk tidak block
        isCasting = true
        holdClick(config.castHoldTime)
        lastCastTime = tick()
        isCasting = false
    end)
end

local function quickTap()
    local clickX, clickY = getClickPosition()
    
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, true, game, 0)
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, false, game, 0)
end

local function detectMinigame()
    if miniGameGUI and miniGameGUI.Parent then
        local bg = miniGameGUI:FindFirstChild("Background")
        if bg then
            local filler = bg:FindFirstChild("Filler")
            return filler ~= nil, filler
        end
    end
    return false, nil
end

-- ===== OPTIMIZED AUTO CLICK (NO LAG) =====
local clickCount = 0
local maxClicksPerFrame = 1 -- Limit clicks per frame

local function startAutoClick()
    if clickConnection then clickConnection:Disconnect() end
    
    clickConnection = RunService.Heartbeat:Connect(function()
        if not config.enabled or isCasting then return end
        
        -- Update UI cache periodically
        updateUICache()
        
        local active, filler = detectMinigame()
        
        if wasMinigameActive and not active then
            fishCaught = fishCaught + 1
        end
        
        wasMinigameActive = active
        isMinigameActive = active
        
        if active and filler then
            -- Limit clicks per frame untuk avoid lag
            if clickCount >= maxClicksPerFrame then
                clickCount = 0
                return
            end
            
            if config.autoWinMode then
                if filler.Size.X.Scale < 0.99 then
                    filler.Size = UDim2.new(0.99, 0, 1, 0)
                    quickTap()
                    clickCount = clickCount + 1
                end
            else
                if filler.Size.X.Scale < 1 then
                    quickTap()
                    clickCount = clickCount + 1
                end
            end
        else
            clickCount = 0
        end
    end)
end

local function monitorRecast()
    task.spawn(function()
        while config.enabled do
            task.wait(1)
            
            if not isMinigameActive and not isCasting then
                local active = detectMinigame()
                if not active then
                    local timeSinceCast = tick() - lastCastTime
                    
                    if timeSinceCast >= 1.2 then
                        castFishingRod()
                    end
                end
            end
        end
    end)
end

local function updateLoop()
    task.spawn(function()
        while config.enabled do
            task.wait(1)
            if tick() - lastWebhookUpdate >= config.updateInterval then
                sendStatusUpdate()
                lastWebhookUpdate = tick()
            end
        end
    end)
end

-- ===== UTILITY FUNCTIONS =====
local function getFPS()
    return 60 -- Return static untuk avoid calculation lag
end

local function getPing()
    local ping = 0
    pcall(function()
        ping = math.floor(Stats.Network.ServerStatsItem["Data Ping"]:GetValue())
    end)
    return ping
end

local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = seconds % 60
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

-- ===== TOGGLE FUNCTION =====
local function toggleScript()
    config.enabled = not config.enabled
    
    if config.enabled then
        fishCaught = 0
        startTime = tick()
        stoppedTime = 0
        lastWebhookUpdate = tick()
        sessionStart = os.date("%Y-%m-%d %H:%M:%S")
        
        -- Reset cache
        fishingRodGUI = nil
        miniGameGUI = nil
        imageLabel = nil
        lastUICheck = 0
        
        if toggleBtn then
            toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 220, 50)
            toggleBtn.Text = "STOP"
        end
        
        sendStartMessage()
        updateUICache()
        startAutoClick()
        monitorRecast()
        startAntiAFK()
        updateLoop()
        task.wait(0.2)
        castFishingRod()
    else
        stoppedTime = math.floor(tick() - startTime)
        
        if toggleBtn then
            toggleBtn.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
            toggleBtn.Text = "START"
        end
        
        sendStopMessage()
        if clickConnection then clickConnection:Disconnect() end
        stopAntiAFK()
    end
end

-- ===== GUI =====
local function createGUI()
    local oldGui = playerGui:FindFirstChild("AutoFishGUI")
    if oldGui then oldGui:Destroy() end
    
    local sg = Instance.new("ScreenGui")
    sg.Name = "AutoFishGUI"
    sg.ResetOnSpawn = false
    sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    sg.Parent = playerGui
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 240, 0, 240)
    frame.Position = UDim2.new(0.5, -120, 0, 80)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    frame.BorderSizePixel = 0
    frame.Active = true
    frame.Draggable = false
    frame.Parent = sg
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = frame
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -50, 0, 35)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    title.BorderSizePixel = 0
    title.Text = "Auto Fishing"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 15
    title.TextColor3 = Color3.new(1, 1, 1)
    title.TextXAlignment = Enum.TextXAlignment.Center
    title.TextYAlignment = Enum.TextYAlignment.Center
    title.Active = true
    title.Parent = frame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 10)
    titleCorner.Parent = title
    
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0, 2.5)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    closeBtn.BorderSizePixel = 0
    closeBtn.Text = "X"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.AutoButtonColor = true
    closeBtn.Parent = frame
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeBtn
    
    toggleBtn = Instance.new("TextButton")
    toggleBtn.Size = UDim2.new(0.9, 0, 0, 40)
    toggleBtn.Position = UDim2.new(0.05, 0, 0, 45)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    toggleBtn.BorderSizePixel = 0
    toggleBtn.Text = "START"
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextSize = 14
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.AutoButtonColor = true
    toggleBtn.Parent = frame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 8)
    toggleCorner.Parent = toggleBtn
    
    local modeBtn = Instance.new("TextButton")
    modeBtn.Size = UDim2.new(0.9, 0, 0, 30)
    modeBtn.Position = UDim2.new(0.05, 0, 0, 95)
    modeBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
    modeBtn.BorderSizePixel = 0
    modeBtn.Text = "Mode: Tap-Tap"
    modeBtn.Font = Enum.Font.GothamBold
    modeBtn.TextSize = 12
    modeBtn.TextColor3 = Color3.new(1, 1, 1)
    modeBtn.AutoButtonColor = true
    modeBtn.Parent = frame
    
    local modeCorner = Instance.new("UICorner")
    modeCorner.CornerRadius = UDim.new(0, 6)
    modeCorner.Parent = modeBtn
    
    statsLabel = Instance.new("TextLabel")
    statsLabel.Size = UDim2.new(0.9, 0, 0, 90)
    statsLabel.Position = UDim2.new(0.05, 0, 0, 135)
    statsLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    statsLabel.BorderSizePixel = 0
    statsLabel.Text = "Fish: 0\nTime: 00:00:00\nPing: 0ms"
    statsLabel.Font = Enum.Font.GothamBold
    statsLabel.TextSize = 12
    statsLabel.TextColor3 = Color3.fromRGB(0, 255, 150)
    statsLabel.TextXAlignment = Enum.TextXAlignment.Left
    statsLabel.TextYAlignment = Enum.TextYAlignment.Top
    statsLabel.Parent = frame
    
    local statsPadding = Instance.new("UIPadding")
    statsPadding.PaddingLeft = UDim.new(0, 10)
    statsPadding.PaddingTop = UDim.new(0, 8)
    statsPadding.Parent = statsLabel
    
    local statsCorner = Instance.new("UICorner")
    statsCorner.CornerRadius = UDim.new(0, 8)
    statsCorner.Parent = statsLabel
    
    -- Update Stats Loop (Optimized)
    task.spawn(function()
        while statsLabel and statsLabel.Parent do
            task.wait(2) -- Update setiap 2 detik untuk mengurangi lag
            
            local currentPing = getPing()
            local uptime = 0
            
            if config.enabled then
                uptime = math.floor(tick() - startTime)
            else
                uptime = stoppedTime
            end
            
            local timeStr = formatTime(uptime)
            
            statsLabel.Text = string.format(
                "Fish: %d\nTime: %s\nPing: %dms",
                fishCaught,
                timeStr,
                currentPing
            )
        end
    end)
    
    toggleBtn.MouseButton1Click:Connect(function()
        toggleScript()
    end)
    
    modeBtn.MouseButton1Click:Connect(function()
        config.autoWinMode = not config.autoWinMode
        if config.autoWinMode then
            modeBtn.Text = "Mode: Auto Win"
            modeBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 0)
        else
            modeBtn.Text = "Mode: Tap-Tap"
            modeBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
        end
        if config.enabled then
            sendModeChange()
        end
    end)
    
    closeBtn.MouseButton1Click:Connect(function()
        config.enabled = false
        if clickConnection then clickConnection:Disconnect() end
        stopAntiAFK()
        sg:Destroy()
    end)
    
    -- Drag Functionality
    local dragging = false
    local dragInput = nil
    local dragStart = nil
    local startPos = nil
    
    title.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    title.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    return sg
end

-- ===== HOTKEYS =====
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    if input.KeyCode == Enum.KeyCode.J then
        local gui = playerGui:FindFirstChild("AutoFishGUI")
        if gui then
            local frame = gui:FindFirstChild("Frame")
            if frame then
                frame.Visible = not frame.Visible
            end
        end
    elseif input.KeyCode == Enum.KeyCode.K then
        toggleScript()
    end
end)

-- ===== INITIALIZE =====
task.spawn(function()
    findAFKRemote()
end)

local function sendAttachMessage()
    local currentTime = os.date("%Y-%m-%d %H:%M:%S")
    
    local fields = {
        {name = "üë§ Player", value = "```" .. player.Name .. "```", inline = true},
        {name = "üïê Waktu Attach", value = "```" .. currentTime .. "```", inline = true},
        {name = "‚ö° Kontrol", value = "```J = Toggle GUI\nK = Start/Stop```", inline = false},
        {name = "üìã Status", value = "```yaml\nScript berhasil di-attach\nSiap digunakan```", inline = false}
    }
    
    sendWebhook(
        "ü§ñ Script Attached Successfully",
        "**Auto Fishing Script telah di-attach ke executor!**\nGUI sudah muncul, tekan **K** untuk memulai bot.",
        5763719,
        fields
    )
end

task.wait(0.5)
pcall(createGUI)
task.wait(2)
sendAttachMessage()
