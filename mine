-- Auto Mine | Velocity Executor Compatible
-- Tidak butuh script.Parent / Animations folder

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local mouse = player:GetMouse()

local MineEvent = ReplicatedStorage:WaitForChild("MineEvent")

-- State
local character, humanoid, rootPart
local currentTool = nil
local isEquipped = false
local isMining = false
local mineCount = 0
local autoMineEnabled = false
local m1Track, minedTrack, dapetTrack = nil, nil, nil

--------------------------------------------------
-- FIND TOOL (dynamically detect equipped tool)
--------------------------------------------------
local function findEquippedTool()
	if not character then return nil end
	for _, child in pairs(character:GetChildren()) do
		if child:IsA("Tool") then
			return child
		end
	end
	return nil
end

--------------------------------------------------
-- LOAD ANIMATIONS FROM TOOL
--------------------------------------------------
local function loadAnimations(tool)
	m1Track, minedTrack, dapetTrack = nil, nil, nil
	if not (tool and humanoid) then return end

	local animFolder = tool:FindFirstChild("Animations")
	if not animFolder then return end

	local m1Anim = animFolder:FindFirstChild("M1")
	local minedAnim = animFolder:FindFirstChild("Mined")
	local dapetAnim = animFolder:FindFirstChild("Dapet")

	if m1Anim then m1Track = humanoid:LoadAnimation(m1Anim) end
	if minedAnim then minedTrack = humanoid:LoadAnimation(minedAnim) end
	if dapetAnim then dapetTrack = humanoid:LoadAnimation(dapetAnim) end
end

--------------------------------------------------
-- GUI SETUP
--------------------------------------------------
-- Hapus GUI lama kalau ada (re-run script)
if playerGui:FindFirstChild("AutoMineGui") then
	playerGui:FindFirstChild("AutoMineGui"):Destroy()
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoMineGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 180, 0, 100)
mainFrame.Position = UDim2.new(0, 12, 1, -115)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = false
mainFrame.Parent = screenGui

local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 10)
uiCorner.Parent = mainFrame

local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(60, 60, 70)
stroke.Thickness = 1
stroke.Parent = mainFrame

-- Title
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 0, 28)
titleLabel.Position = UDim2.new(0, 0, 0, 0)
titleLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 48)
titleLabel.BorderSizePixel = 0
titleLabel.Text = "⛏  AUTO MINE"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextScaled = true
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 10)
titleCorner.Parent = titleLabel

local titlePadding = Instance.new("UIPadding")
titlePadding.PaddingLeft = UDim.new(0, 10)
titlePadding.Parent = titleLabel

-- Toggle Button
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 140, 0, 30)
toggleButton.Position = UDim2.new(0.5, 0, 0.5, 4)
toggleButton.AnchorPoint = Vector2.new(0.5, 0.5)
toggleButton.BackgroundColor3 = Color3.fromRGB(80, 80, 90)
toggleButton.BorderSizePixel = 0
toggleButton.Text = "START"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamBold
toggleButton.Parent = mainFrame

local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0, 6)
btnCorner.Parent = toggleButton

-- Status
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 18)
statusLabel.Position = UDim2.new(0, 10, 1, -22)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Status: Idle"
statusLabel.TextColor3 = Color3.fromRGB(140, 140, 150)
statusLabel.TextScaled = true
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = mainFrame

--------------------------------------------------
-- GUI LOGIC
--------------------------------------------------
local COLOR_ON = Color3.fromRGB(50, 180, 100)
local COLOR_OFF = Color3.fromRGB(80, 80, 90)
local COLOR_STATUS_ON = Color3.fromRGB(80, 220, 120)
local COLOR_STATUS_OFF = Color3.fromRGB(140, 140, 150)
local COLOR_STATUS_WARN = Color3.fromRGB(180, 140, 60)

local function updateGui()
	if autoMineEnabled then
		toggleButton.Text = "STOP"
		toggleButton.BackgroundColor3 = COLOR_ON
		statusLabel.Text = "Status: Mining..."
		statusLabel.TextColor3 = COLOR_STATUS_ON
	else
		toggleButton.Text = "START"
		toggleButton.BackgroundColor3 = COLOR_OFF
		statusLabel.Text = "Status: Idle"
		statusLabel.TextColor3 = COLOR_STATUS_OFF
	end
end

toggleButton.MouseEnter:Connect(function()
	TweenService:Create(toggleButton, TweenInfo.new(0.15), {
		BackgroundColor3 = autoMineEnabled and Color3.fromRGB(40, 160, 80) or Color3.fromRGB(100, 100, 115)
	}):Play()
end)

toggleButton.MouseLeave:Connect(function()
	updateGui()
end)

toggleButton.Activated:Connect(function()
	autoMineEnabled = not autoMineEnabled
	mineCount = 0
	updateGui()
end)

--------------------------------------------------
-- CHARACTER SETUP
--------------------------------------------------
local function setupCharacter(char)
	character = char
	humanoid = char:WaitForChild("Humanoid", 5)
	rootPart = char:WaitForChild("HumanoidRootPart", 5)
	currentTool = nil
	m1Track, minedTrack, dapetTrack = nil, nil, nil
	isEquipped = false
	mainFrame.Visible = false
	autoMineEnabled = false
	mineCount = 0
	updateGui()
end

if not (player.Character and player.Character:FindFirstChild("Humanoid")) then
	player.CharacterAdded:Wait()
end
setupCharacter(player.Character)
player.CharacterAdded:Connect(setupCharacter)

--------------------------------------------------
-- DETECT TOOL EQUIPPED / UNEQUIPPED
-- (Executor tidak bisa pakai script.Parent.Equipped)
-- Gunakan ChildAdded / ChildRemoved pada Character
--------------------------------------------------
local function onChildAdded(child)
	if child:IsA("Tool") then
		currentTool = child
		isEquipped = true
		mineCount = 0
		mainFrame.Visible = true
		loadAnimations(child)
		updateGui()
	end
end

local function onChildRemoved(child)
	if child == currentTool then
		currentTool = nil
		isEquipped = false
		autoMineEnabled = false
		mineCount = 0
		m1Track, minedTrack, dapetTrack = nil, nil, nil
		mainFrame.Visible = false
		updateGui()
	end
end

local function connectCharacterEvents()
	if not character then return end
	character.ChildAdded:Connect(onChildAdded)
	character.ChildRemoved:Connect(onChildRemoved)

	-- Cek kalau tool sudah di-equip saat script run
	local tool = findEquippedTool()
	if tool then
		onChildAdded(tool)
	end
end

connectCharacterEvents()
player.CharacterAdded:Connect(function(char)
	task.wait(0.5)
	connectCharacterEvents()
end)

--------------------------------------------------
-- FIND NEAREST BLOCK
--------------------------------------------------
local function findNearestBlock()
	if not rootPart then return nil end
	local nearest = nil
	local nearestDist = math.huge

	for _, obj in pairs(workspace:GetDescendants()) do
		if obj.Name == "Block" and obj:IsA("BasePart") then
			local dist = (rootPart.Position - obj.Position).Magnitude
			if dist <= 10 and dist < nearestDist then
				nearest = obj
				nearestDist = dist
			end
		end
	end
	return nearest
end

--------------------------------------------------
-- AUTO MINE LOOP
--------------------------------------------------
RunService.Heartbeat:Connect(function()
	if not isEquipped or not autoMineEnabled or isMining then return end
	if not (character and humanoid and rootPart) then return end
	if humanoid.Health <= 0 then return end

	local block = findNearestBlock()
	if not block then
		statusLabel.Text = "Status: No block nearby"
		statusLabel.TextColor3 = COLOR_STATUS_WARN
		return
	else
		statusLabel.Text = "Status: Mining..."
		statusLabel.TextColor3 = COLOR_STATUS_ON
	end

	isMining = true

	if m1Track then m1Track:Play() end
	if minedTrack then minedTrack:Play() end

	mineCount = mineCount + 1

	if mineCount >= 8 then
		MineEvent:FireServer(block)
		mineCount = 0
		if dapetTrack then dapetTrack:Play() end
	end

	task.wait(1)
	isMining = false
end)

print("✅ Auto Mine loaded | Equip tool & press START")
