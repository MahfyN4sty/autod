-- Auto Fishing Script with Discord Webhook (Clean Single Status)
-- Hotkey: J = Start/Stop | K = Toggle Mode

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Stats = game:GetService("Stats")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer

-- ===== WEBHOOK DISCORD ANDA =====
local WEBHOOK_URL = "https://discord.com/api/webhooks/1461393962618060957/JAb0w8aEoWOV77_RCjN0fDhGJU5cbic6ZJQqlPL2JMzMztSQfFckuanMbYMXLTGdnNBN"
-- ================================

-- Config
local config = {
    enabled = false,
    autoWinMode = false,
    antiAFK = true,
    clickDelay = 0.05,
    castHoldTime = 0.6,
    updateInterval = 60, -- Update setiap 60 detik (1 menit)
    webhookEnabled = true
}

-- Status Variables
local isMinigameActive = false
local isCasting = false
local clickConnection = nil
local lastCastTime = 0
local fishCaught = 0
local wasMinigameActive = false
local startTime = 0
local afkRemote = nil
local lastWebhookUpdate = 0
local sessionStart = os.date("%Y-%m-%d %H:%M:%S")

-- Anti-AFK Loops
local afkSpamLoop = nil
local afkMouseLoop = nil

-- ===== DISCORD WEBHOOK FUNCTIONS =====
local function sendWebhookRequest(data)
    local success = false
    
    pcall(function()
        if http_request then
            http_request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = data
            })
            success = true
        end
    end)
    
    if success then return true end
    
    pcall(function()
        if request then
            request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = data
            })
            success = true
        end
    end)
    
    if success then return true end
    
    pcall(function()
        if syn and syn.request then
            syn.request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = data
            })
            success = true
        end
    end)
    
    return success
end

local function sendWebhook(title, description, color, fields)
    if not config.webhookEnabled then return end
    
    local embed = {
        ["title"] = title,
        ["description"] = description,
        ["color"] = color or 3447003,
        ["fields"] = fields or {},
        ["footer"] = {
            ["text"] = "Auto Fish Bot ‚Ä¢ " .. player.Name
        },
        ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
    }
    
    local data = {
        ["embeds"] = {embed}
    }
    
    local jsonData = HttpService:JSONEncode(data)
    sendWebhookRequest(jsonData)
end

local function sendStatusUpdate()
    if not config.enabled then return end
    
    local runtime = math.floor(tick() - startTime)
    local hours = math.floor(runtime / 3600)
    local minutes = math.floor((runtime % 3600) / 60)
    local secs = runtime % 60
    local timeStr = string.format("%02dh %02dm %02ds", hours, minutes, secs)
    
    local fps = 0
    pcall(function()
        fps = math.floor(1 / RunService.Heartbeat:Wait())
    end)
    
    local ping = 0
    pcall(function()
        ping = math.floor(Stats.Network.ServerStatsItem["Data Ping"]:GetValue())
    end)
    
    local fishPerHour = runtime > 0 and math.floor(fishCaught / (runtime / 3600)) or 0
    
    local fields = {
        {name = "üìä Status", value = "```yaml\n‚úÖ AKTIF BERJALAN```", inline = false},
        {name = "‚öôÔ∏è Mode", value = "```" .. (config.autoWinMode and "Auto Win" or "Tap-Tap") .. "```", inline = true},
        {name = "üé£ Ikan", value = "```" .. tostring(fishCaught) .. "```", inline = true},
        {name = "‚è±Ô∏è Runtime", value = "```" .. timeStr .. "```", inline = true},
        {name = "üìà Ikan/Jam", value = "```" .. tostring(fishPerHour) .. "```", inline = true},
        {name = "üñ•Ô∏è FPS", value = "```" .. tostring(fps) .. "```", inline = true},
        {name = "üì° Ping", value = "```" .. tostring(ping) .. "ms```", inline = true},
        {name = "üïê Mulai", value = "```" .. sessionStart .. "```", inline = false}
    }
    
    sendWebhook(
        "üé£ Auto Fishing - Status Update",
        "*Live monitoring - Update setiap " .. config.updateInterval .. " detik*",
        16776960,
        fields
    )
end

local function sendStartMessage()
    local fields = {
        {name = "üë§ Player", value = "```" .. player.Name .. "```", inline = true},
        {name = "‚öôÔ∏è Mode", value = "```" .. (config.autoWinMode and "Auto Win" or "Tap-Tap") .. "```", inline = true},
        {name = "üïê Session Start", value = "```" .. sessionStart .. "```", inline = false},
        {name = "‚ö° Kontrol", value = "```J = Start/Stop\nK = Toggle Mode```", inline = false}
    }
    
    sendWebhook(
        "üé£ Auto Fishing Started",
        "**Bot telah diaktifkan!**\nStatus akan di-update secara berkala.",
        3066993,
        fields
    )
end

local function sendStopMessage()
    local runtime = math.floor(tick() - startTime)
    local hours = math.floor(runtime / 3600)
    local minutes = math.floor((runtime % 3600) / 60)
    local secs = runtime % 60
    local timeStr = string.format("%02dh %02dm %02ds", hours, minutes, secs)
    
    local fishPerHour = runtime > 0 and math.floor(fishCaught / (runtime / 3600)) or 0
    
    local fields = {
        {name = "üé£ Total Ikan", value = "```" .. tostring(fishCaught) .. "```", inline = true},
        {name = "‚è±Ô∏è Runtime", value = "```" .. timeStr .. "```", inline = true},
        {name = "üìà Ikan/Jam", value = "```" .. tostring(fishPerHour) .. "```", inline = true},
        {name = "üìä Summary", value = "```yaml\nBot telah dihentikan\nSesi selesai```", inline = false}
    }
    
    sendWebhook(
        "üõë Auto Fishing Stopped",
        "**Bot telah dinonaktifkan**",
        15158332,
        fields
    )
end

local function sendModeChange()
    if not config.enabled then return end
    
    local runtime = math.floor(tick() - startTime)
    local hours = math.floor(runtime / 3600)
    local minutes = math.floor((runtime % 3600) / 60)
    local secs = runtime % 60
    local timeStr = string.format("%02dh %02dm %02ds", hours, minutes, secs)
    
    local fields = {
        {name = "‚öôÔ∏è Mode Baru", value = "```" .. (config.autoWinMode and "Auto Win" or "Tap-Tap") .. "```", inline = true},
        {name = "üé£ Ikan", value = "```" .. tostring(fishCaught) .. "```", inline = true},
        {name = "‚è±Ô∏è Runtime", value = "```" .. timeStr .. "```", inline = true}
    }
    
    sendWebhook(
        "‚öôÔ∏è Mode Changed",
        "**Mode fishing telah diubah**",
        10181046,
        fields
    )
end

-- ===== ANTI-AFK SYSTEM =====
local function findAFKRemote()
    afkRemote = ReplicatedStorage:FindFirstChild("AFK")
    if not afkRemote then
        task.wait(2)
        afkRemote = ReplicatedStorage:FindFirstChild("AFK")
    end
    return afkRemote
end

local function startAntiAFK()
    if not afkRemote then
        findAFKRemote()
    end
    
    if not afkRemote then
        return
    end
    
    UserInputService.WindowFocusReleased:Connect(function()
        if config.enabled then
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    UserInputService.WindowFocused:Connect(function()
        if config.enabled then
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    if afkSpamLoop then
        task.cancel(afkSpamLoop)
    end
    
    afkSpamLoop = task.spawn(function()
        while config.enabled do
            task.wait(1)
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    if afkMouseLoop then
        task.cancel(afkMouseLoop)
    end
    
    afkMouseLoop = task.spawn(function()
        while config.enabled do
            task.wait(3)
            local vp = workspace.CurrentCamera.ViewportSize
            pcall(function()
                VirtualInputManager:SendMouseMoveEvent(
                    vp.X/2 + math.random(-2, 2),
                    vp.Y/2 + math.random(-2, 2),
                    game
                )
            end)
        end
    end)
end

local function stopAntiAFK()
    if afkSpamLoop then
        task.cancel(afkSpamLoop)
        afkSpamLoop = nil
    end
    if afkMouseLoop then
        task.cancel(afkMouseLoop)
        afkMouseLoop = nil
    end
end

-- ===== FISHING FUNCTIONS =====
local function getBlueAreaPosition()
    local playerGui = player:WaitForChild("PlayerGui")
    local fishingRodGUI = playerGui:FindFirstChild("FishingRodGUI")
    
    if fishingRodGUI then
        local background = fishingRodGUI:FindFirstChild("Background")
        if background then
            local imageLabel = background:FindFirstChild("ImageLabel")
            if imageLabel then
                -- Dapatkan posisi absolut dari ImageLabel
                local absolutePos = imageLabel.AbsolutePosition
                local absoluteSize = imageLabel.AbsoluteSize
                
                -- Klik di tengah area biru
                local clickX = absolutePos.X + (absoluteSize.X / 2)
                local clickY = absolutePos.Y + (absoluteSize.Y / 2)
                
                return clickX, clickY
            end
        end
    end
    
    -- Fallback ke tengah layar jika UI tidak ditemukan
    local center = workspace.CurrentCamera.ViewportSize / 2
    return center.X, center.Y
end

local function holdClick(duration)
    local clickX, clickY = getBlueAreaPosition()
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, true, game, 0)
    task.wait(duration)
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, false, game, 0)
end

-- =====DIATAS UPDATE (Sedang di Tes)======

local function quickTap()
    local center = workspace.CurrentCamera.ViewportSize / 2
    VirtualInputManager:SendMouseButtonEvent(center.X, center.Y, 0, true, game, 0)
    task.wait(0.01)
    VirtualInputManager:SendMouseButtonEvent(center.X, center.Y, 0, false, game, 0)
end

local function detectMinigame()
    local playerGui = player:WaitForChild("PlayerGui")
    local miniGameGui = playerGui:FindFirstChild("MiniGameGUI")
    if miniGameGui then
        local bg = miniGameGui:FindFirstChild("Background")
        if bg then
            local filler = bg:FindFirstChild("Filler")
            return filler ~= nil, filler
        end
    end
    return false, nil
end

local function startAutoClick()
    if clickConnection then clickConnection:Disconnect() end
    
    clickConnection = RunService.Heartbeat:Connect(function()
        if not config.enabled or isCasting then return end
        
        local active, filler = detectMinigame()
        
        if wasMinigameActive and not active then
            fishCaught = fishCaught + 1
        end
        
        wasMinigameActive = active
        isMinigameActive = active
        
        if active and filler then
            if config.autoWinMode then
                if filler.Size.X.Scale < 0.99 then
                    filler.Size = UDim2.new(0.99, 0, 1, 0)
                    task.wait(0.05)
                    quickTap()
                    task.wait(0.5)
                end
            else
                if filler.Size.X.Scale < 1 then
                    quickTap()
                    task.wait(config.clickDelay)
                end
            end
        end
    end)
end

local function monitorRecast()
    task.spawn(function()
        while config.enabled do
            task.wait(1)
            if not isMinigameActive and not isCasting then
                local active = detectMinigame()
                if not active and tick() - lastCastTime >= 1 then
                    castFishingRod()
                end
            end
        end
    end)
end

local function updateLoop()
    task.spawn(function()
        while config.enabled do
            task.wait(1)
            if tick() - lastWebhookUpdate >= config.updateInterval then
                sendStatusUpdate()
                lastWebhookUpdate = tick()
            end
        end
    end)
end

-- ===== TOGGLE FUNCTIONS =====
local function toggleScript()
    config.enabled = not config.enabled
    
    if config.enabled then
        fishCaught = 0
        startTime = tick()
        lastWebhookUpdate = tick()
        sessionStart = os.date("%Y-%m-%d %H:%M:%S")
        
        sendStartMessage()
        startAutoClick()
        monitorRecast()
        startAntiAFK()
        updateLoop()
        task.wait(0.5)
        castFishingRod()
    else
        sendStopMessage()
        if clickConnection then clickConnection:Disconnect() end
        stopAntiAFK()
    end
end

local function toggleMode()
    config.autoWinMode = not config.autoWinMode
    if config.enabled then
        sendModeChange()
    end
end

-- ===== HOTKEYS =====
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    if input.KeyCode == Enum.KeyCode.J then
        toggleScript()
    elseif input.KeyCode == Enum.KeyCode.K then
        toggleMode()
    end
end)

-- ===== INITIALIZE =====
task.spawn(function()
    findAFKRemote()
end)

-- ===== PESAN ATTACH EXECUTOR =====
local function sendAttachMessage()
    local currentTime = os.date("%Y-%m-%d %H:%M:%S")
    
    local fields = {
        {name = "üë§ Player", value = "```" .. player.Name .. "```", inline = true},
        {name = "üïê Waktu Attach", value = "```" .. currentTime .. "```", inline = true},
        {name = "‚ö° Kontrol", value = "```J = Start/Stop\nK = Toggle Mode```", inline = false},
        {name = "üìã Status", value = "```yaml\nScript berhasil di-attach\nSiap digunakan```", inline = false}
    }
    
    sendWebhook(
        "ü§ñ Script Attached Successfully",
        "**Auto Fishing Script telah di-attach ke executor!**\nTekan **J** untuk memulai bot.",
        5763719, -- Warna biru/hijau
        fields
    )
end

-- Kirim pesan attach setelah 2 detik (tunggu semua service siap)
task.wait(2)
sendAttachMessage()
