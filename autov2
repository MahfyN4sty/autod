-- ===== ANTI-DOUBLE SCRIPT SYSTEM =====
local scriptIdentifier = "AutoFishingBestVersion"

-- Check if script already running
if _G[scriptIdentifier] then
    _G[scriptIdentifier]:Destroy()
    task.wait(0.5)
end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Stats = game:GetService("Stats")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Config
local config = {
    enabled = false,
    autoWinMode = false,
    antiAFK = true,
    castHoldTime = 0.6,
    fSpamSpeed = 0.015,      -- Normal: 66 F/sec
    fSpamSpeedFast = 0.005,  -- Ultra Fast: 200 F/sec!
    castDelay = 2
}

-- Status Variables
local isMinigameActive = false
local isCasting = false
local fSpamLoop = nil
local lastCastTime = 0
local fishCaught = 0
local startTime = 0
local stoppedTime = 0
local afkRemote = nil
local fPressCount = 0

-- Anti-AFK Loops
local afkSpamLoop = nil
local afkMouseLoop = nil

-- GUI Reference
local toggleBtn = nil
local modeBtn = nil
local statsLabel = nil

-- ===== ANTI-AFK SYSTEM =====
local function findAFKRemote()
    afkRemote = ReplicatedStorage:FindFirstChild("AFK")
    if not afkRemote then
        task.wait(2)
        afkRemote = ReplicatedStorage:FindFirstChild("AFK")
    end
    return afkRemote
end

local function startAntiAFK()
    if not afkRemote then
        findAFKRemote()
    end
    
    if not afkRemote then
        return
    end
    
    UserInputService.WindowFocusReleased:Connect(function()
        if config.enabled then
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    UserInputService.WindowFocused:Connect(function()
        if config.enabled then
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    if afkSpamLoop then
        task.cancel(afkSpamLoop)
    end
    
    afkSpamLoop = task.spawn(function()
        while config.enabled do
            task.wait(1)
            pcall(function() afkRemote:FireServer(false) end)
        end
    end)
    
    if afkMouseLoop then
        task.cancel(afkMouseLoop)
    end
    
    afkMouseLoop = task.spawn(function()
        while config.enabled do
            task.wait(3)
            local vp = workspace.CurrentCamera.ViewportSize
            pcall(function()
                VirtualInputManager:SendMouseMoveEvent(
                    vp.X/2 + math.random(-2, 2),
                    vp.Y/2 + math.random(-2, 2),
                    game
                )
            end)
        end
    end)
end

local function stopAntiAFK()
    if afkSpamLoop then
        task.cancel(afkSpamLoop)
        afkSpamLoop = nil
    end
    if afkMouseLoop then
        task.cancel(afkMouseLoop)
        afkMouseLoop = nil
    end
end

-- ===== CLICK POSITION =====
local function getClickPosition()
    local fishingRodGUI = playerGui:FindFirstChild("FishingRodGUI")
    
    if fishingRodGUI then
        local background = fishingRodGUI:FindFirstChild("Background")
        if background then
            local imageLabel = background:FindFirstChild("ImageLabel")
            if imageLabel then
                local absolutePos = imageLabel.AbsolutePosition
                local absoluteSize = imageLabel.AbsoluteSize
                
                local clickX = absolutePos.X + (absoluteSize.X / 2)
                local clickY = absolutePos.Y + absoluteSize.Y + 30
                
                return clickX, clickY
            end
        end
    end
    
    local center = workspace.CurrentCamera.ViewportSize / 2
    return center.X, center.Y
end

-- ===== FISHING FUNCTIONS =====
local function holdClick(duration)
    local clickX, clickY = getClickPosition()
    
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, true, game, 0)
    task.wait(duration)
    VirtualInputManager:SendMouseButtonEvent(clickX, clickY, 0, false, game, 0)
end

local function castFishingRod()
    if isCasting then return end
    isCasting = true
    holdClick(config.castHoldTime)
    lastCastTime = tick()
    task.wait(0.3)
    isCasting = false
end

local function pressKey(keyCode)
    VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
    task.wait(0.01)
    VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
end

-- ===== MINIGAME DETECTION =====
local function isMiniGameActive()
    local miniGameGUI = playerGui:FindFirstChild("MiniGameGUI")
    if miniGameGUI and miniGameGUI:IsA("ScreenGui") then
        return miniGameGUI.Enabled == true
    end
    return false
end

local function getMinigameFiller()
    local miniGameGUI = playerGui:FindFirstChild("MiniGameGUI")
    if not miniGameGUI then return nil end
    
    local background = miniGameGUI:FindFirstChild("Background")
    if not background then return nil end
    
    local filler = background:FindFirstChild("Filler")
    if filler and filler:IsA("Frame") then
        return filler
    end
    
    return nil
end

-- ===== DUAL MODE SYSTEM: INSTANT CAST + F-SPAM =====
local wasInMinigame = false
local lastActionTime = 0

local function startFSpamLoop()
    if fSpamLoop then
        fSpamLoop:Disconnect()
    end
    
    fSpamLoop = RunService.RenderStepped:Connect(function()
        if not config.enabled then return end
        
        local inMinigame = isMiniGameActive()
        local currentTime = tick()
        
        -- Detect minigame START
        if inMinigame and not wasInMinigame then
            fPressCount = 0
            isMinigameActive = true
        end
        
        -- Detect minigame END
        if not inMinigame and wasInMinigame then
            fishCaught = fishCaught + 1
            isMinigameActive = false
            fPressCount = 0
            lastActionTime = currentTime
        end
        
        wasInMinigame = inMinigame
        
        if inMinigame then
            -- SPAM F during minigame
            pressKey(Enum.KeyCode.F)
            fPressCount = fPressCount + 1
            
            -- Use different speed based on mode
            if config.autoWinMode then
                task.wait(config.fSpamSpeedFast)  -- ULTRA FAST: 200 F/sec
            else
                task.wait(config.fSpamSpeed)       -- Normal: 66 F/sec
            end
        else
            -- NO MINIGAME = CAST IMMEDIATELY!
            if not isCasting and currentTime - lastActionTime >= 0.3 then
                isCasting = true
                
                task.spawn(function()
                    holdClick(config.castHoldTime)
                    lastCastTime = tick()
                    task.wait(0.2)
                    isCasting = false
                end)
                
                lastActionTime = currentTime
            end
        end
    end)
end

local function stopFSpamLoop()
    if fSpamLoop then
        fSpamLoop:Disconnect()
        fSpamLoop = nil
    end
    isMinigameActive = false
end

-- ===== UTILITY FUNCTIONS =====
local function getFPS()
    local fps = 0
    pcall(function()
        fps = math.floor(1 / RunService.Heartbeat:Wait())
    end)
    return fps
end

local function getPing()
    local ping = 0
    pcall(function()
        ping = math.floor(Stats.Network.ServerStatsItem["Data Ping"]:GetValue())
    end)
    return ping
end

local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = seconds % 60
    return string.format("%02d:%02d:%02d", hours, minutes, secs)
end

-- ===== TOGGLE FUNCTION =====
local function toggleScript()
    config.enabled = not config.enabled
    
    if config.enabled then
        fishCaught = 0
        startTime = tick()
        stoppedTime = 0
        fPressCount = 0
        wasInMinigame = false
        
        if toggleBtn then
            toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 220, 50)
            toggleBtn.Text = "STOP"
        end
        
        startFSpamLoop()
        startAntiAFK()
        
    else
        stoppedTime = math.floor(tick() - startTime)
        
        if toggleBtn then
            toggleBtn.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
            toggleBtn.Text = "START"
        end
        
        stopFSpamLoop()
        stopAntiAFK()
    end
end

-- ===== BEAUTIFUL GUI =====
local function createGUI()
    local oldGui = playerGui:FindFirstChild("AutoFishGUI")
    if oldGui then oldGui:Destroy() end
    
    local sg = Instance.new("ScreenGui")
    sg.Name = "AutoFishGUI"
    sg.ResetOnSpawn = false
    sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    sg.Parent = playerGui
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 260, 0, 270)
    frame.Position = UDim2.new(0.5, -130, 0, 80)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    frame.BorderSizePixel = 0
    frame.Active = true
    frame.Draggable = false
    frame.Parent = sg
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = frame
    
    -- Glow Effect
    local glow = Instance.new("ImageLabel")
    glow.Size = UDim2.new(1, 40, 1, 40)
    glow.Position = UDim2.new(0.5, 0, 0.5, 0)
    glow.AnchorPoint = Vector2.new(0.5, 0.5)
    glow.BackgroundTransparency = 1
    glow.Image = "rbxasset://textures/ui/Glow.png"
    glow.ImageColor3 = Color3.fromRGB(0, 200, 255)
    glow.ImageTransparency = 0.7
    glow.ZIndex = 0
    glow.Parent = frame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -50, 0, 40)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(0, 180, 255)
    title.BorderSizePixel = 0
    title.Text = "üé£ Auto Fishing"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.TextColor3 = Color3.new(1, 1, 1)
    title.TextXAlignment = Enum.TextXAlignment.Center
    title.TextYAlignment = Enum.TextYAlignment.Center
    title.Active = true
    title.Parent = frame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 12)
    titleCorner.Parent = title
    
    -- Gradient for title
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 200, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 150, 255))
    }
    gradient.Rotation = 45
    gradient.Parent = title
    
    -- Close Button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 35, 0, 35)
    closeBtn.Position = UDim2.new(1, -37, 0, 2.5)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    closeBtn.BorderSizePixel = 0
    closeBtn.Text = "‚úï"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 18
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.AutoButtonColor = true
    closeBtn.Parent = frame
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 8)
    closeCorner.Parent = closeBtn
    
    -- Toggle Button
    toggleBtn = Instance.new("TextButton")
    toggleBtn.Size = UDim2.new(0.9, 0, 0, 45)
    toggleBtn.Position = UDim2.new(0.05, 0, 0, 50)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    toggleBtn.BorderSizePixel = 0
    toggleBtn.Text = "START"
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextSize = 16
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.AutoButtonColor = true
    toggleBtn.Parent = frame
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 10)
    toggleCorner.Parent = toggleBtn
    
    -- Toggle gradient
    local toggleGradient = Instance.new("UIGradient")
    toggleGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 70, 70)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 40, 40))
    }
    toggleGradient.Rotation = 90
    toggleGradient.Parent = toggleBtn
    
    -- Mode Button
    modeBtn = Instance.new("TextButton")
    modeBtn.Size = UDim2.new(0.9, 0, 0, 40)
    modeBtn.Position = UDim2.new(0.05, 0, 0, 105)
    modeBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
    modeBtn.BorderSizePixel = 0
    modeBtn.Text = "‚å®Ô∏è Speed: Normal (66/s)"
    modeBtn.Font = Enum.Font.GothamBold
    modeBtn.TextSize = 14
    modeBtn.TextColor3 = Color3.new(1, 1, 1)
    modeBtn.AutoButtonColor = true
    modeBtn.Parent = frame
    
    local modeCorner = Instance.new("UICorner")
    modeCorner.CornerRadius = UDim.new(0, 10)
    modeCorner.Parent = modeBtn
    
    -- Mode gradient
    local modeGradient = Instance.new("UIGradient")
    modeGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(120, 120, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 80, 200))
    }
    modeGradient.Rotation = 90
    modeGradient.Parent = modeBtn
    
    -- Stats Display
    statsLabel = Instance.new("TextLabel")
    statsLabel.Size = UDim2.new(0.9, 0, 0, 100)
    statsLabel.Position = UDim2.new(0.05, 0, 0, 155)
    statsLabel.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    statsLabel.BorderSizePixel = 2
    statsLabel.BorderColor3 = Color3.fromRGB(0, 180, 255)
    statsLabel.Text = "üêü Fish: 0\n‚è±Ô∏è Time: 00:00:00\nüìä FPS: 0\nüì° Ping: 0ms"
    statsLabel.Font = Enum.Font.GothamBold
    statsLabel.TextSize = 14
    statsLabel.TextColor3 = Color3.new(1, 1, 1)
    statsLabel.TextXAlignment = Enum.TextXAlignment.Left
    statsLabel.TextYAlignment = Enum.TextYAlignment.Top
    statsLabel.Parent = frame
    
    local statsPadding = Instance.new("UIPadding")
    statsPadding.PaddingLeft = UDim.new(0, 12)
    statsPadding.PaddingTop = UDim.new(0, 10)
    statsPadding.Parent = statsLabel
    
    local statsCorner = Instance.new("UICorner")
    statsCorner.CornerRadius = UDim.new(0, 10)
    statsCorner.Parent = statsLabel
    
    -- Update Stats Loop
    task.spawn(function()
        while statsLabel and statsLabel.Parent do
            task.wait(0.5)
            
            local currentFPS = getFPS()
            local currentPing = getPing()
            local uptime = 0
            
            if config.enabled then
                uptime = math.floor(tick() - startTime)
            else
                uptime = stoppedTime
            end
            
            local timeStr = formatTime(uptime)
            
            -- Dynamic status indicator
            local statusEmoji = "‚è∏Ô∏è"
            local statusText = "Stopped"
            
            if isMinigameActive then
                if config.autoWinMode then
                    statusEmoji = "‚ö°"
                    statusText = "Ultra Fast!"
                else
                    statusEmoji = "‚å®Ô∏è"
                    statusText = "F-Spamming"
                end
            elseif config.enabled then
                statusEmoji = "üé£"
                statusText = "Fishing..."
            end
            
            statsLabel.Text = string.format(
                "%s Status: %s\nüêü Fish: %d\n‚è±Ô∏è Time: %s\nüìä FPS: %d | üì° Ping: %dms",
                statusEmoji,
                statusText,
                fishCaught,
                timeStr,
                currentFPS,
                currentPing
            )
            
            -- Change stats color when active
            if isMinigameActive then
                if config.autoWinMode then
                    statsLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
                    statsLabel.BorderColor3 = Color3.fromRGB(255, 200, 0)
                else
                    statsLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
                    statsLabel.BorderColor3 = Color3.fromRGB(100, 255, 100)
                end
            elseif config.enabled then
                statsLabel.TextColor3 = Color3.fromRGB(0, 200, 255)
                statsLabel.BorderColor3 = Color3.fromRGB(0, 200, 255)
            else
                statsLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                statsLabel.BorderColor3 = Color3.fromRGB(0, 180, 255)
            end
        end
    end)
    
    -- Button Functions
    toggleBtn.MouseButton1Click:Connect(function()
        toggleScript()
        
        -- Update button gradient on toggle
        if config.enabled then
            toggleGradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0, Color3.fromRGB(70, 255, 70)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 200, 40))
            }
        else
            toggleGradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 70, 70)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 40, 40))
            }
        end
    end)
    
    modeBtn.MouseButton1Click:Connect(function()
        config.autoWinMode = not config.autoWinMode
        
        if config.autoWinMode then
            modeBtn.Text = "‚ö° Speed: ULTRA (200/s)"
            modeGradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 180, 0)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 120, 0))
            }
        else
            modeBtn.Text = "‚å®Ô∏è Speed: Normal (66/s)"
            modeGradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0, Color3.fromRGB(120, 120, 255)),
                ColorSequenceKeypoint.new(1, Color3.fromRGB(80, 80, 200))
            }
        end
        
        -- Restart loop with new speed if running
        if config.enabled then
            stopFSpamLoop()
            task.wait(0.1)
            startFSpamLoop()
        end
    end)
    
    closeBtn.MouseButton1Click:Connect(function()
        config.enabled = false
        stopFSpamLoop()
        stopAntiAFK()
        sg:Destroy()
    end)
    
    -- Drag Functionality
    local dragging = false
    local dragInput = nil
    local dragStart = nil
    local startPos = nil
    
    title.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    title.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    -- Hotkey J (Start/Stop)
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.J then
            toggleScript()
        end
    end)
    
    -- Hotkey K (Hide/Show GUI)
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.K then
            frame.Visible = not frame.Visible
        end
    end)
    
    return sg
end

-- ===== INITIALIZE =====
task.spawn(function()
    findAFKRemote()
end)

task.wait(0.5)

local success, err = pcall(function()
    local gui = createGUI()
    _G[scriptIdentifier] = gui
end)

if not success then
    task.wait(1)
    pcall(function()
        local gui = createGUI()
        _G[scriptIdentifier] = gui
    end)
end
